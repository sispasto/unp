<div class="container-fluid">
  <form id="formConsulta">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-6 col-xl-5">
        <div class="card shadow border-0">

          <!-- HEADER -->
          <div class="card-header bg-dark text-white d-flex align-items-center" style="height: 3rem;">
            <h5 class="card-title mb-0 fw-bold">Consulta de Marcaciones</h5>
          </div>

          <!-- BODY -->
          <div class="card-body">

            <div class="mb-3">
              <label for="codigoConsulta" class="form-label">Código Nómina</label>
              <input
                type="number"
                class="form-control"
                id="codigoConsulta"
                required
              >
            </div>

            <div class="mb-3">
              <label for="fechaConsulta" class="form-label">Fecha</label>
              <input
                type="date"
                class="form-control"
                id="fechaConsulta"
                required
              >
            </div>

            <!-- RESULTADOS -->
            <div id="resultadoMarcaciones" class="mt-3"></div>

          </div>

          <!-- FOOTER -->
          <div class="card-footer d-flex gap-2">
            <button type="submit" class="btn btn-dark flex-fill">
              CONSULTAR
            </button>
          </div>

        </div>
      </div>
    </div>
  </form>
</div>

<script>
window.nsConsulta = (function () {

  function init() {
    const form = document.getElementById("formConsulta");
    if (!form) return;

    form.addEventListener("submit", consultar);
  }

  async function consultar(event) {
    event.preventDefault();

    const codigo = document.getElementById("codigoConsulta").value.trim();
    const fecha = document.getElementById("fechaConsulta").value;
    const contenedor = document.getElementById("resultadoMarcaciones");

    contenedor.innerHTML = "";

    if (!codigo || !fecha) {
      alertSMS("Debe ingresar código y fecha");
      return;
    }

    try {
      const response = await fetch(
        `${SUPABASE_URL}/functions/v1/consultar_marcaciones`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
            "apikey": SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ codigo, fecha })
        }
      );

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || "Error al consultar marcaciones");
      }

      renderizar(result.empleado, result.registros);

    } catch (error) {
      console.error(error);
      alertSMS(error.message);
    }
  }

  function renderizar(nombreEmpleado, registros) {
    const contenedor = document.getElementById("resultadoMarcaciones");

    if (!registros || registros.length === 0) {
      contenedor.innerHTML = `
        <div class="alert alert-warning text-center">
          No hay marcaciones para esta fecha
        </div>
      `;
      return;
    }

    let html = `
      <div class="alert alert-secondary text-center fw-bold">
        ${nombreEmpleado}
      </div>
      <ul class="list-group">
    `;

    registros.forEach(r => {
      html += `
        <li class="list-group-item d-flex justify-content-between">
          <span>${r.fecha}</span>
          <span class="fw-bold">${r.hora}</span>
        </li>
      `;
    });

    html += `</ul>`;
    contenedor.innerHTML = html;
  }

  return {
    init
  };

})();
</script>
