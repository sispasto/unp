<style>   
  .icono {
    width: 32px;
    height: 32px;
    max-width: 60%;
  }

  /* Estilo adicional para texto */
  .texto-icono {
    font-size: 10px;
    font-family: 'Poppins', sans-serif;
  }

  /* Tama√±o para pantallas grandes (PC) */
  @media screen and (min-width: 768px) {
    .icono {
      width: 48px;
      height: 48px;
    }

    .texto-icono {
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
    }
  }
</style>
<div>
  <div class="container-fluid"> <!--deja un espacio minimo del borde de la pantalla-->
    <h3></h3>
    <!-- <div class="output"> </div> -->
    <form id="formulario" onsubmit="nsRegistro.procesarFormulario(event,this)">
      <div class="container-fluid p-0 m-0">
        <div class="row justify-content-center">
          <div class="col-12 col-sm-12 col-md-12 col-lg-6 col-xl-5">
            <div class="card shadow border-0">
              <div class="card-header bg-dark text-white d-flex align-items-center" style="height: 3rem;">
                <h5 class="card-title mb-0 fw-bold">Registro de Asistencia</h5>
              </div>
              <div class="card-body">
                <div class="text-center mb-4">
                  <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#staticBackdrop" id="opencamera">
                    <i class="bi bi-camera-fill"></i>
                  </button>
                </div>

                <div class="mb-3">
                  <label for="codnomina" class="form-label">C√≥digo N√≥mina</label>
                  <input type="number" class="form-control" id="codnomina" name="codnomina">
                  <span id="namePromotor" class="form-text text-muted"></span>
                </div>

                <div class="mb-3" style="display: block;">
                  <label for="fecha" class="form-label">Fecha</label>
                  <input type="text" class="form-control" id="fecha" name="fecha" readonly>
                </div>

                <div class="mb-3" style="display: block;">
                  <label for="hora" class="form-label">Hora</label>
                  <input type="text" class="form-control" id="hora" name="hora" readonly>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6 mb-2">
                    <input type="radio" class="btn-check" name="tiporegistro" id="rbtEntrada" value="ENTRADA" autocomplete="off" checked>
                    <label class="btn btn-outline-primary w-100" for="rbtEntrada">Entrada</label>
                  </div>

                  <div class="col-md-6 mb-2">
                    <input type="radio" class="btn-check" name="tiporegistro" id="rbtSalida" value="SALIDA" autocomplete="off">
                    <label class="btn btn-outline-primary w-100" for="rbtSalida">Salida</label>
                  </div>
                </div>


                <div class="mb-3" style="display: block;">
                  <label for="ubicacion" class="form-label">Ubicaci√≥n</label>
                  <input type="text" class="form-control" id="coordenadas" name="coordenadas" readonly>
                  <!-- Campos ocultos para la imagen y mapa -->
                  <input id="pathIMG" name="pathIMG">
                  <input id="IDImg" name="IDImg">
                  <input id="mapa" name="mapa">
                </div> 
              </div>              
              <div class="card-footer d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-fill" id="frmSubmit">Enviar</button>
                <button type="button" class="btn btn-secondary flex-fill" id="limpiar">Nuevo</button>
              </div>
            </div>
          </div>
        </div>
      </div>      
    </form>
  </div>
</div>
<script>  
var nsRegistro=(function(){ 
    /******************************************************************************************************/ 
    var dataForm = null;
    /****************************************Obteniendo la ubicaci√≥n actual********************************/
    let latitude='';
    let longitude='';
    let options = {
      enableHighAccuracy: true,
      timeout: 30000,
      maximumAge: 27000,
    };

    function success(pos) {//log("Tu ubicaci√≥n actual:");.log(`Latitud : ${crd.latitude}`);log(`+- ${crd.accuracy} metros.`);
      let crd = pos.coords;
      latitude = crd.latitude;
      longitude = crd.longitude;
      document.getElementById("coordenadas").value= latitude+","+longitude;
      document.getElementById("mapa").value= "https://www.google.com/maps?q=" + latitude+","+longitude;
      saveImage(); 
    }

    function error(err) {
      if(err.code == 1) {
        alertSMS("Error: El acceso a la ubicaci√≥n esta deshabilitado!");
        latitude='';longitude='';
      } else if( err.code == 2) {    
        alertSMS("Error: No se pudo calcular la ubicaci√≥n!");  
        latitude='';longitude='';
      }
      //console.warn(`ERROR(${err.code}): ${err.message}`);
    }
    
   async function getLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject("Geolocalizaci√≥n no soportada");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          const coords = `${lat},${lng}`;

          // Solo visual
          document.getElementById("coordenadas").value = coords;

          resolve(coords);
        },
        err => {
          reject("No se pudo obtener la ubicaci√≥n");
        },
        options
      );
    });
  }

    
    /****************************************Definiaci√≥n de variables globales**************************************/   
    //var arrayGlobal=[];//arreglo de promotores
    var banPromotor=0;//variable para determinar si el promotor fue encontrado    
    let submitDesdeBoton = false;    
    let canvas = null;
    /******************************************************************************************************/
    /****************************************Definici√≥n de eventos HTML***********************************/  
    document.querySelectorAll('input[type=number]').forEach( node => node.addEventListener('keypress', e => {
      if(e.keyCode == 13) {e.preventDefault();                    
      }
    }));//Se captura la tecla enter para evitar el envio del formulario       
   
    // Detectar si el bot√≥n fue presionado con mouse
    document.getElementById("frmSubmit").addEventListener("mousedown", () => {      
    });
    
    document.getElementById("codnomina").addEventListener("change", async () => {       
        
    });

    document.getElementById('limpiar').addEventListener('click', function() {
        clean();
    });
    // Se pasa 1 para saber que es evento de boton 

    function clean(){//resetea el contador
      document.getElementById("namePromotor").textContent = "";
      document.getElementById("formulario").reset();
      banPromotor = 0; nsModal.numClic=0;
      let canvas = nsRegistro.getCanvas();
      var context = canvas.getContext('2d');      
      context.clearRect(0, 0, canvas.width, canvas.height)
      
    }
    /******************************************************************************************************/
    //C√≥digo nuestro   

    function obtenerTipoRegistro() {
      const seleccionado = document.querySelector(
        'input[name="tiporegistro"]:checked'
      );
      return seleccionado ? seleccionado.value : null;
    }


   async function procesarFormulario(event, formulario) {
      event.preventDefault();

      const boton = document.getElementById("frmSubmit");
      boton.disabled = true;
      boton.classList.add("disabled");

      try {
        const codigo = document.getElementById("codnomina").value.trim();

        if (!codigo) {
          alertSMS("Ingrese su c√≥digo");
          return;
        }

        const tipoRegistro = obtenerTipoRegistro();
        if (!tipoRegistro) {
          alertSMS("Seleccione el tipo de registro");
          return;
        }

        // üìç Obtener ubicaci√≥n
        const ubicacion = await getLocation();

        // 1Ô∏è‚É£ INSERTAR MARCACI√ìN
        const { error: errorInsert } = await supabaseClient
          .from("pmarcaciones")
          .insert({
            codigo: codigo,
            tipo_registro: tipoRegistro,
            ubicacion: ubicacion,
            foto: null
          });

        if (errorInsert) {
          console.error("Error al insertar marcaci√≥n:", errorInsert);
          alertSMS("C√≥digo no v√°lido o no autorizado");
          return;
        }

        // 2Ô∏è‚É£ OBTENER EMPLEADO COMPLETO
        const { data: empleado, error: errorEmpleado } = await supabaseClient
          .from("pempleados")
          .select("nombre,estado")
          .eq("codigo", codigo)
          .single();

        if (errorEmpleado || !empleado) {
          console.error("Error al obtener empleado:", errorEmpleado);
          alertSMS("Marcaci√≥n registrada, pero no se pudo obtener el empleado");
          return;
        }

        // ‚úÖ AQU√ç YA TIENES TODOS LOS CAMPOS DEL EMPLEADO
        console.log("Empleado:", empleado);
        document.getElementById("namePromotor").innerHTML =
        empleado.nombre.toUpperCase();

        alertSMS(`Marcaci√≥n registrada correctamente para ${empleado.nombre}`);
        formulario.reset();

      } catch (err) {
        console.error("Error general:", err);
        alertSMS("No se pudo registrar la marcaci√≥n");
      } finally {
        boton.disabled = false;
        boton.classList.remove("disabled");
      }
    }

   /********************************************************************************************************/
    async function getPromotor() {
      crearLoader();

      const codnomina = document.getElementById("codnomina").value;

      if (!codnomina) {
        alertSMS("Ingrese el c√≥digo");
        eliminarLoader();
        return false;
      }

      const { data, error } = await supabaseClient
        .from("pempleados")
        .select("codigo, cedula, nombre, estado")
        .eq("codigo", codnomina)
        .single();

      if (error || !data) {
        alertSMS("El c√≥digo no existe");
        eliminarLoader();
        return false;
      }

      if (!data.estado) {
        alertSMS("Empleado inactivo");
        eliminarLoader();
        return false;
      }

      banPromotor = 1;
      document.getElementById("namePromotor").innerHTML =
        data.nombre.toUpperCase();

      eliminarLoader();
      return true;
    }

   /********************************************************************************************************/


    function setDate(){ 
      let date = new Date();      
      let hora = date.toLocaleTimeString("es-CO", { hour12: false });  
      let fecha = date.toLocaleDateString('es-CO');      
      document.getElementById("fecha").value = fecha; //day+'-'+month+'-'+year;        
      document.getElementById("hora").value = hora ;//hours+':'+minutes;    
    }

    /*************************************Guardar Imagen***************************************************/
    function enviarFormularioConFetch() {
      fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body: new URLSearchParams({
          action: 'escribirDatosEnSheets', // Puedes cambiarlo seg√∫n c√≥mo lo procese tu backend
          ...dataForm
        })
      })
      .then(response => response.json())
      .then(data => {
        escribioHoja(data);
      })
      .catch(error => {
        errorescrituraHoja(error);
      });
    }

    function successFull(data){ //console.log("devuelta:" + data ); //console.log(data.url); 
      document.getElementById("pathIMG").value = data.url;
      document.getElementById("IDImg").value = data.fileID;    
      dataForm = Object.fromEntries(new FormData(formulario).entries());   
      enviarFormularioConFetch(dataForm); 
    }

    function errorUpload(data){ 
      eliminarLoader();
      document.getElementById("fecha").value = "";
      document.getElementById("hora").value = "";//hours+':'+minutes; 
      document.getElementById("coordenadas").value= "";
      document.getElementById("mapa").value= "";
      latitude='';
      longitude='';
    }
    
    function saveImage(){ 
      if( nsModal.numClic > 0 ){
        crearLoader(); 
        let canvas = nsRegistro.getCanvas();
        //let dataURi = canvas.toDataURL('image/png');
        let dataURi = canvas.toDataURL('image/jpeg', 0.6);
        let idImg = document.getElementById("codnomina").value + "-" + document.getElementById("fecha").value;  
        subirImagen(dataURi,idImg,folderPathIMG);  
      }
      else{
        alertSMS("La fotograf√≠a es necesaria");
      }        
    }//Fin funci√≥n saveImage   

    async function subirImagen(dataURI, idImg, folderPathIMG) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body: new URLSearchParams({
            action: 'doUpload',
            data: dataURI,
            idImg: idImg,
            folderPathIMG: folderPathIMG
          })
        });

        const result = await response.json();

        if (result.status) { 
          successFull(result);  // llama tu funci√≥n de √©xito          
        } else {
          errorUpload("No se pudo subir la imagen"); //         
        }

      } catch (error) {
        console.error("Error en fetch:", error);
        errorUpload(error.message || "Error en la conexi√≥n");
      }
    }


    function escribioHoja(datos) {
      const { E1, S1, E2, S2, sms, existeMarcacion } = datos;
      console.log("E1:", E1.estado, "Hora:", E1.hora);
      console.log("S1:", S1.estado, "Hora:", S1.hora);
      console.log("E2:", E2.estado, "Hora:", E2.hora);
      console.log("S2:", S2.estado, "Hora:", S2.hora);
      console.log("sms:", sms);
      console.log("existeMarcacion:", existeMarcacion); 
      // Asignar √≠conos usando estado
      asignarIcono("e1", E1.estado);
      asignarIcono("s1", S1.estado);
      asignarIcono("e2", E2.estado);
      asignarIcono("s2", S2.estado);

      asignarHora("he1", E1.hora);
      asignarHora("hs1", S1.hora);
      asignarHora("he2", E2.hora);
      asignarHora("hs2", S2.hora);

      eliminarLoader();
      clean();

      if (sms !== "")
        alertSMS( sms );
      else if (existeMarcacion)
        alertSMS("No se puede duplicar una entrada o salida");
      else
        alertSMS("Registro creado con √©xito");
    }

    function asignarHora(id, hora) {
      const div = document.getElementById(id);
      if (div) {
        div.innerText = hora || ""; // Asigna la hora o deja vac√≠o si no hay hora
      }
    }   

    function errorescrituraHoja(){
      eliminarLoader();
      alertSMS("No se pudieron registrar los datos vuelva a intentar"); 
    }
    
    /******************************************************************************************************/    
    
     function setCanvas(c) {
      canvas = c;
     }

     function getCanvas() {
        return canvas;
     }

      // Expone las funciones p√∫blicas del m√≥dulo
    return {
        procesarFormulario,
        setCanvas,
        getCanvas
    };
    
  })();

  </script>

