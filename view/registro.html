<style>   
  .icono {
    width: 32px;
    height: 32px;
    max-width: 60%;
  }

  .texto-icono {
    font-size: 10px;
    font-family: 'Poppins', sans-serif;
  }

  @media screen and (min-width: 768px) {
    .icono {
      width: 48px;
      height: 48px;
    }

    .texto-icono {
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
    }
  }
</style>

<div>
  <div class="container-fluid">
    <h3></h3>
    <form id="formulario" onsubmit="nsRegistro.procesarFormulario(event,this)">
      <div class="container-fluid p-0 m-0">
        <div class="row justify-content-center">
          <div class="col-12 col-sm-12 col-md-12 col-lg-6 col-xl-5">
            <div class="card shadow border-0">
              <div class="card-header bg-dark text-white d-flex align-items-center" style="height: 3rem;">
                <h5 class="card-title mb-0 fw-bold">Registro de Asistencia</h5>
              </div>
              <div class="card-body">
                <div class="text-center mb-4">
                  <button type="button" class="btn btn-dark" id="opencamera">
                    <i class="bi bi-camera-fill"></i>
                  </button>
                </div>

                <div class="mb-3">
                  <label for="codnomina" class="form-label">Código Nómina</label>
                  <input type="number" class="form-control" id="codnomina" name="codnomina">
                  <span id="namePromotor" class="form-text text-muted"></span>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6 mb-2">
                    <input type="radio" class="btn-check" name="tiporegistro" id="rbtEntrada" value="ENTRADA" autocomplete="off" checked>
                    <label class="btn btn-outline-primary w-100" for="rbtEntrada">Entrada</label>
                  </div>
                  <div class="col-md-6 mb-2">
                    <input type="radio" class="btn-check" name="tiporegistro" id="rbtSalida" value="SALIDA" autocomplete="off">
                    <label class="btn btn-outline-primary w-100" for="rbtSalida">Salida</label>
                  </div>
                </div>

                <div class="mb-3" style="display: none;">
                  <label for="ubicacion" class="form-label">Ubicación</label>
                  <input type="text" class="form-control" id="coordenadas" name="coordenadas" readonly>
                </div> 
              </div>

              <div class="card-footer d-flex gap-2">
                <button type="submit" class="btn btn-dark flex-fill" id="frmSubmit">
                  MARCAR ASISTENCIA
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>      
    </form>
  </div>
</div>

<script>
  // ==========================
  // Abrir cámara usando foto-component
  // ==========================
  const btnCamera = document.getElementById('opencamera');
  btnCamera?.addEventListener('click', () => {
    const fotoComp = document.querySelector('foto-component');
    if (fotoComp) {
      fotoComp.openCamera(); // Abrir modal de cámara
    } else {
      console.error("FotoComponent no encontrado en la página");
    }
  });

  // ==========================
  // Módulo nsRegistro actualizado
  // ==========================
  var nsRegistro = (function() {
    const SUPABASE_URL = "https://pmbxyfketmuzocepllvf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtYnh5ZmtldG11em9jZXBsbHZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3ODE4NjUsImV4cCI6MjA3MzM1Nzg2NX0.oh9zssayvCPp-jcCohQugTx28Ds2Ts-y7Tbp-pgX1XE";

    let latitude = '';
    let longitude = '';
    const options = { enableHighAccuracy: true, timeout: 30000, maximumAge: 27000 };

    async function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject("Geolocalización no soportada");
        navigator.geolocation.getCurrentPosition(
          pos => {
            latitude = pos.coords.latitude;
            longitude = pos.coords.longitude;
            const coords = `${latitude},${longitude}`;
            document.getElementById("coordenadas").value = coords;
            resolve(coords);
          },
          err => reject("No se pudo obtener la ubicación"),
          options
        );
      });
    }

    function obtenerTipoRegistro() {
      const seleccionado = document.querySelector('input[name="tiporegistro"]:checked');
      return seleccionado ? seleccionado.value : null;
    }

    async function procesarFormulario(event, formulario) {
      event.preventDefault();
      const boton = document.getElementById("frmSubmit");
      boton.disabled = true;
      boton.classList.add("disabled");

      try {
        const codigo = document.getElementById("codnomina").value.trim();
        if (!codigo) return alertSMS("Ingrese su código");

        const tipoRegistro = obtenerTipoRegistro();
        if (!tipoRegistro) return alertSMS("Seleccione el tipo de registro");

        const fotoComp = document.querySelector('foto-component');
        if (!fotoComp) throw new Error("FotoComponent no cargado");

        if (fotoComp.getNumClic() <= 0) return alertSMS("La fotografía es obligatoria");

        const ubicacion = await getLocation();

        const canvas = fotoComp.getCanvas();
        const fotoBlob = await new Promise(resolve => canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.6));
        if (!fotoBlob) throw new Error("No se pudo generar la imagen");

        const formData = new FormData();
        formData.append("codigo", codigo);
        formData.append("tipo_registro", tipoRegistro);
        formData.append("ubicacion", JSON.stringify(ubicacion));
        formData.append("foto", fotoBlob, "foto.jpg");

        const response = await fetch(`${SUPABASE_URL}/functions/v1/registrar_marcacion`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
            "apikey": SUPABASE_ANON_KEY
          },
          body: formData
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error || "Error al registrar marcación");

        document.getElementById("namePromotor").innerHTML = result.empleado.nombre.toUpperCase();
        alertSMS(`Marcación registrada correctamente para ${result.empleado.nombre}`);

        // Limpiar canvas y formulario
        fotoComp.reset();
        formulario.reset();

      } catch (err) {
        console.error(err);
        alertSMS(err.message);
      } finally {
        boton.disabled = false;
        boton.classList.remove("disabled");
      }
    }

    return { procesarFormulario };
  })();
</script>
