<style>
  .tabla-personas {
    font-size: 0.9rem;
  }
</style>

<div class="container-fluid mt-3">

  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">

      <div class="card shadow border-0">

        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-bold">Consulta de Personas</h5>
          <input
            type="text"
            class="form-control form-control-sm w-50"
            placeholder="Buscar por cÃ³digo, cÃ©dula o nombre"
            onkeyup="nsConsultarPersonas.filtrar(this.value)"
          >
        </div>

        <div class="card-body p-0">

          <div id="alertaConsulta" class="p-3"></div>

          <div class="table-responsive">
            <table class="table table-hover table-striped mb-0 tabla-personas">
              <thead class="table-dark">
                <tr>
                  <th>CÃ³digo</th>
                  <th>CÃ©dula</th>
                  <th>Nombre</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody id="tbodyPersonas"></tbody>
            </table>
          </div>

        </div>

      </div>

    </div>
  </div>

</div>

<script>
var nsConsultarPersonas = (function () {

  /***********************************************/
  const SUPABASE_URL = "https://pmbxyfketmuzocepllvf.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtYnh5ZmtldG11em9jZXBsbHZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3ODE4NjUsImV4cCI6MjA3MzM1Nzg2NX0.oh9zssayvCPp-jcCohQugTx28Ds2Ts-y7Tbp-pgX1XE";
  /***********************************************/
  let personas = [];

  async function cargar() {
    try {
      
      const res = await fetch(
        `${SUPABASE_URL}/functions/v1/consultar_personas`,
        {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
            "apikey": SUPABASE_ANON_KEY
          },
          body: JSON.stringify({}) // ðŸ‘ˆ OBLIGATORIO
        }
      );

      const result = await res.json();

      if (!res.ok) throw new Error(result.error || "Error al consultar personas");

      personas = result.data.sort(
        (a, b) => Number(a.codigo) - Number(b.codigo)
      );

      render(personas);

    } catch (err) {
      mostrarError(err.message);
    }
  }

  function render(data) {
    const tbody = document.getElementById("tbodyPersonas");
    tbody.innerHTML = "";

    if (!data.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="text-center text-muted py-3">
            No hay registros
          </td>
        </tr>
      `;
      return;
    }

    data.forEach(p => {
      tbody.innerHTML += `
        <tr>
          <td>${p.codigo}</td>
          <td>${p.cedula}</td>
          <td>${p.nombre}</td>
          <td>
            <span class="badge ${p.estado ? "bg-success" : "bg-secondary"}">
              ${p.estado ? "ACTIVO" : "INACTIVO"}
            </span>
          </td>
        </tr>
      `;
    });
  }

  function filtrar(txt) {
    txt = txt.toLowerCase();

    const filtradas = personas.filter(p =>
      String(p.codigo).includes(txt) ||
      String(p.cedula).includes(txt) ||
      p.nombre.toLowerCase().includes(txt)
    );

    // Mantener orden numÃ©rico despuÃ©s del filtro
    filtradas.sort((a, b) => Number(a.codigo) - Number(b.codigo));

    render(filtradas);
  }


  function mostrarError(msg) {
    document.getElementById("alertaConsulta").innerHTML = `
      <div class="alert alert-danger">${msg}</div>
    `;
  }

  return {
    cargar,
    filtrar
  };

})();

// ðŸ‘‡ ejecutar automÃ¡ticamente
document.addEventListener("DOMContentLoaded", () => {
  nsConsultarPersonas.cargar();
});
</script>


